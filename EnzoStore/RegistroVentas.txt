CREATE DATABASE IF NOT EXISTS `bdenzostore` /*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci */ /*!80016 DEFAULT ENCRYPTION='N' */;
USE `bdenzostore`;

DROP TABLE IF EXISTS `usuarios`;
CREATE TABLE IF NOT EXISTS `usuarios` (
  `id` int NOT NULL AUTO_INCREMENT,
  `nombres` varchar(45) DEFAULT NULL,
  `apellidos` varchar(45) DEFAULT NULL,
  `correo` varchar(45) DEFAULT NULL,
  `contrase√±a` varchar(45) DEFAULT NULL,
  `tipo_contacto` varchar(45) DEFAULT NULL,
  `historial_compras` varchar(45) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=14 DEFAULT CHARSET=latin1;

DROP TABLE IF EXISTS `prendas`;
CREATE TABLE IF NOT EXISTS `prendas` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `nombre` varchar(45) DEFAULT NULL,
  `colores` varchar(45) DEFAULT NULL,
  `talla` varchar(45) DEFAULT NULL,
  `descripcion` varchar(45) DEFAULT NULL,
  `precio` double DEFAULT NULL,
  `estado` varchar(45) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=26 DEFAULT CHARSET=latin1;

DROP TABLE IF EXISTS `ventas`;
CREATE TABLE IF NOT EXISTS `ventas` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `nombreyapellido` varchar(45) DEFAULT NULL,
  `direccion` varchar(45) DEFAULT NULL,
  `punto_referencia` varchar(45) DEFAULT NULL,
  `telefono` varchar(45) DEFAULT NULL,
  `idusuario` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `fkpedidousuario` (`idusuario`),
  CONSTRAINT `fkventasusuario` FOREIGN KEY (`idusuario`) REFERENCES `usuarios` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=latin1;

DROP TABLE IF EXISTS `detalle_pedido`;
CREATE TABLE IF NOT EXISTS `detalle_pedido` (
  `idpedido` int(11) NOT NULL AUTO_INCREMENT,
  `idusuario` int(11) DEFAULT NULL,
  `idventa` int(11) DEFAULT NULL,
  `id_prenda` int(11) NOT NULL,
  `cantidad` int(11) DEFAULT NULL,
  KEY `fkpedidodetallepedido_idx` (`idpedido`),
  KEY `fkpedidousuario` (`idusuario`),
  KEY `fkpedidoventas` (`idventa`),
  KEY `fkpedidoprenda` (`id_prenda`),
  CONSTRAINT `fkpedidousuario` FOREIGN KEY (`idusuario`) REFERENCES `usuarios` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION,
  CONSTRAINT `fkpedidoventas` FOREIGN KEY (`idventa`) REFERENCES `ventas` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION,
  CONSTRAINT `fkpedidoprenda` FOREIGN KEY (`id_prenda`) REFERENCES `prendas` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

DROP VIEW IF EXISTS `obtener_detalles_pedido`;
CREATE
    ALGORITHM = UNDEFINED 
    DEFINER = `root`@`localhost` 
    SQL SECURITY DEFINER
VIEW `obtener_detalles_pedido` AS
    SELECT 
        `detp`.`idpedido` AS `id`,
        `detp`.`idventa` AS `codigo venta`,
        `usu`.`id` AS `idusuario`,
        CONCAT(`usu`.`nombres`, ' ', `usu`.`apellidos`) AS `nombreusuario`,
        CONCAT(`pre`.`id` , ' - ', `pre`.`nombre`) AS `prenda`,
        `detp`.`cantidad` AS `cantidad`
    FROM
        (((`detalle_pedido` `detp`
        JOIN `ventas` `vent` ON ((`vent`.`id` = `detp`.`idventa`)))
        JOIN `usuarios` `usu` ON ((`usu`.`id` = `detp`.`idusuario`)))
        JOIN `prendas` `pre` ON ((`pre`.`id` = `detp`.`id_prenda`)))
	ORDER BY `detp`.`idpedido`
